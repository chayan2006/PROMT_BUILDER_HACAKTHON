version: '3.8'

services:
  # 1. API Gateway (Traefik) - Free reverse proxy and load balancer
  traefik:
    image: traefik:v3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # 2. Database (TimescaleDB OSS extension on PostgreSQL for P2/P3 time-series)
  postgres:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ecosystem_db
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # 3. Message Broker (Kafka KRaft mode - no Zookeeper)
  kafka:
    image: apache/kafka:latest
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
    ports:
      - "9092:9092"

  # 4. Redis (For Caching, Pub/Sub, and Celery Broker)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # 5. Identity Provider (Keycloak)
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8081:8080"
    depends_on:
      - postgres

  # 6. Observability (Prometheus + Grafana)
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"

  # 7. Celery Worker (Async Tasks)
  celery_worker:
    build: .
    command: celery -A celery_worker.celery_app worker --loglevel=info
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      - redis

  # 8. FastAPI Backend
  backend:
    build: .
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://admin:password@postgres:5432/ecosystem_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - redis
      - kafka

  # 9. Local LLM (Ollama)
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  # 10. NoSQL DB (MongoDB for P1 Catalog and P6 Reviews)
  mongodb:
    image: mongo:6-jammy
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  # 11. Search Engine (Meilisearch for P1 Catalog Search)
  meilisearch:
    image: getmeili/meilisearch:v1.6
    environment:
      - MEILI_MASTER_KEY=marketplace_search_key
    ports:
      - "7700:7700"
    volumes:
      - meili_data:/meili_data

  # 12. Debezium Change Data Capture (CDC from Postgres to Kafka)
  debezium:
    image: quay.io/debezium/connect:2.5
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
    ports:
      - "8083:8083"
    depends_on:
      - kafka
      - postgres

volumes:
  pgdata:
  ollama_data:
  mongo_data:
  meili_data:
